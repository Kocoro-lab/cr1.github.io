# 你画我猜 - 技术设计文档

## 系统架构

### 整体架构

```
┌─────────────────────────────────────┐
│         用户界面层 (UI Layer)        │
│     index.html + main.css          │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│      应用层 (Application Layer)      │
│          main.js (入口)             │
└──────┬──────────────────┬───────────┘
       │                  │
┌──────▼──────┐    ┌─────▼──────────┐
│ 画板组件     │    │ 游戏管理器      │
│ DrawingCanvas│    │ GameManager    │
└──────────────┘    └────────────────┘
```

### 模块职责

#### 1. UI Layer (用户界面层)
- **index.html**: 定义页面结构和布局
- **main.css**: 负责页面样式和响应式设计
- **交互元素**: 按钮、输入框、画布等

#### 2. Application Layer (应用层)
- **main.js**: 应用入口，负责模块初始化和事件绑定
- **协调作用**: 连接画板组件和游戏管理器

#### 3. Component Layer (组件层)
- **DrawingCanvas**: 封装 Canvas 绘图逻辑
- **GameManager**: 封装游戏规则和状态管理

## 核心技术实现

### 1. Canvas 绘图实现

#### 绘图原理

```javascript
// 1. 鼠标按下 - 开始路径
ctx.beginPath();
ctx.moveTo(x, y);

// 2. 鼠标移动 - 绘制线条
ctx.lineTo(x, y);
ctx.stroke();

// 3. 鼠标松开 - 结束路径
ctx.beginPath();
```

#### 触摸事件处理

```javascript
// 兼容移动端触摸
canvas.addEventListener('touchstart', e => {
  e.preventDefault();  // 防止页面滚动
  handleStart(e.touches[0]);
});
```

#### 坐标转换

```javascript
// 将屏幕坐标转换为画布坐标
const rect = canvas.getBoundingClientRect();
const x = event.clientX - rect.left;
const y = event.clientY - rect.top;
```

### 2. 游戏状态管理

#### 状态定义

```javascript
{
  currentWord: String,    // 当前词汇
  score: Number,          // 当前分数
  usedWords: Set,         // 已使用词汇集合
  wordList: Object        // 词库（按难度分类）
}
```

#### 状态流转

```
[开始] → [选择词汇] → [绘制] → [提交] → [评分] → [显示结果] → [下一题]
   ↑                                                         │
   └─────────────────────────────────────────────────────────┘
```

### 3. 评分系统设计

#### 当前实现（演示版）

```javascript
// 随机评分，用于演示
const scores = [
  { success: true, points: 10, message: '...' },
  { success: true, points: 7, message: '...' },
  // ...
];
return scores[Math.floor(Math.random() * scores.length)];
```

#### 未来改进方案

**方案 A: 基于 TensorFlow.js**
```javascript
// 1. 加载预训练模型
const model = await tf.loadLayersModel('model.json');

// 2. 预处理图像
const tensor = tf.browser.fromPixels(canvas)
  .resizeBilinear([224, 224])
  .expandDims(0)
  .toFloat()
  .div(255.0);

// 3. 模型推理
const prediction = await model.predict(tensor);

// 4. 解析结果
const result = Array.from(prediction.dataSync());
```

**方案 B: 像素分析法**
```javascript
// 简单的像素密度和分布分析
function analyzeDrawing(imageData) {
  const pixels = imageData.data;
  let nonWhitePixels = 0;

  for (let i = 0; i < pixels.length; i += 4) {
    if (pixels[i] !== 255 ||
        pixels[i+1] !== 255 ||
        pixels[i+2] !== 255) {
      nonWhitePixels++;
    }
  }

  return {
    coverage: nonWhitePixels / (width * height),
    complexity: calculateComplexity(pixels)
  };
}
```

## 数据结构设计

### 词库结构

```javascript
wordList: {
  easy: [
    '太阳',    // 形状简单，特征明显
    '月亮',    // 容易识别
    // ...
  ],
  medium: [
    '汽车',    // 需要一定细节
    '飞机',    // 多个组成部分
    // ...
  ],
  hard: [
    '彩虹',    // 需要多种颜色
    '蝴蝶',    // 对称结构，细节较多
    // ...
  ]
}
```

### 评分数据结构

```javascript
evaluation: {
  success: Boolean,      // 是否成功
  points: Number,        // 得分 (0-10)
  message: String,       // 评价消息
  correctWord: String,   // 正确答案
  similarity: Number     // 相似度 (0-1) [可选]
}
```

## 性能优化

### 1. Canvas 优化

- **离屏渲染**: 使用离屏 Canvas 进行复杂图形计算
- **分层绘制**: 将静态背景和动态内容分层
- **requestAnimationFrame**: 使用 RAF 优化动画

### 2. 事件优化

- **事件节流**: 限制 mousemove 事件触发频率
- **被动监听器**: 触摸事件使用 passive: true

```javascript
// 节流示例
let lastTime = 0;
const throttle = 16; // 约 60fps

canvas.addEventListener('mousemove', e => {
  const now = Date.now();
  if (now - lastTime < throttle) return;
  lastTime = now;
  draw(e);
});
```

### 3. 内存管理

- **及时清理**: 清除不再使用的 Canvas 上下文
- **图像数据缓存**: 避免重复获取 ImageData
- **资源释放**: 游戏结束时释放相关资源

## 安全考虑

### 1. 输入验证

- 验证颜色值格式
- 限制画笔大小范围
- 防止异常数据导致程序崩溃

### 2. XSS 防护

- 使用 textContent 而非 innerHTML（显示分数等）
- 对用户可能影响的内容进行转义

### 3. 资源限制

- 限制画布尺寸，防止内存溢出
- 限制词库大小
- 控制事件监听器数量

## 浏览器兼容性

### Canvas API 兼容性

| 功能 | Chrome | Firefox | Safari | Edge |
|-----|--------|---------|--------|------|
| 基础绘图 | ✅ 全支持 | ✅ 全支持 | ✅ 全支持 | ✅ 全支持 |
| 触摸事件 | ✅ 90+ | ✅ 88+ | ✅ 14+ | ✅ 90+ |
| lineCap | ✅ 全支持 | ✅ 全支持 | ✅ 全支持 | ✅ 全支持 |
| getImageData | ✅ 全支持 | ✅ 全支持 | ✅ 全支持 | ✅ 全支持 |

### 降级策略

```javascript
// 检测 Canvas 支持
if (!canvas.getContext) {
  alert('您的浏览器不支持 Canvas，请升级浏览器！');
  return;
}

// 检测触摸支持
const isTouchDevice = 'ontouchstart' in window;
```

## 构建和部署

### 构建流程

```
源代码 → Vite 构建 → 代码压缩 → 资源优化 → 输出 dist/
```

### GitHub Actions 自动部署

```yaml
# 触发条件：push 到 main 分支
# 执行步骤：
1. 检出代码
2. 安装 Node.js
3. 安装依赖
4. 执行构建
5. 部署到 GitHub Pages
```

### 部署配置

- **Base URL**: `/cr1.github.io/`
- **输出目录**: `dist/`
- **分支**: `gh-pages`

## 测试策略

### 单元测试

```javascript
// 测试 DrawingCanvas
describe('DrawingCanvas', () => {
  test('should initialize with correct size', () => {
    expect(canvas.width).toBe(600);
    expect(canvas.height).toBe(400);
  });

  test('should detect empty canvas', () => {
    expect(canvas.isEmpty()).toBe(true);
  });
});
```

### 集成测试

- 测试完整的游戏流程
- 测试各模块间的交互
- 测试事件处理

### 手动测试清单

- [ ] 桌面端鼠标绘图
- [ ] 移动端触摸绘图
- [ ] 颜色切换功能
- [ ] 笔刷大小调整
- [ ] 清空画板功能
- [ ] 提交和跳过功能
- [ ] 分数累加正确
- [ ] 词汇不重复
- [ ] 响应式布局

## 未来扩展方向

### 短期计划

1. 添加橡皮擦工具
2. 支持撤销/重做功能
3. 优化移动端体验
4. 添加音效

### 中期计划

1. 集成真实的 AI 识别
2. 添加难度选择
3. 支持保存作品
4. 添加成就系统

### 长期计划

1. 多人在线模式
2. 用户系统和排行榜
3. 自定义词库
4. 社交分享功能

## 参考资料

- [MDN Canvas API](https://developer.mozilla.org/zh-CN/docs/Web/API/Canvas_API)
- [TensorFlow.js](https://www.tensorflow.org/js)
- [Vite 官方文档](https://vitejs.dev/)
- [GitHub Pages 文档](https://docs.github.com/en/pages)
